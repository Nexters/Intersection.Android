<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Daum</title>
    <script type="text/javascript"
            src="http://apis.daum.net/maps/maps3.js?apikey=116a4f4af54e184168d563e7b11ab9d402047979&libraries=services"></script>
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <!--
    이 부분을 추가해야지만 Gencoder 객체를 쓸 수가 있다.
    &libraries=services
    -->
    <style type="text/css">
        #map {
        width: 100%;
        height: 100vw;
        }
    </style>
</head>
<body>
<div class="container">
    <div id="map"></div>
    <nav>
        <button onclick="drawFillPolygon()">다각형버튼</button>
        <button onclick="drawCircle()">원형버튼</button>
        <button onclick="drawClear()">클리어버튼</button>
        <div id="address_name"></div>
    </nav>
</div>
<script type="text/javascript">
    var markers = [];

    var selectedItem = {
        area: null,
        center: null,
        addressName: null,
        transPlaces: null,
        transMarkers: null
    };

    var areaConfig = {
//        center : new daum.maps.LatLng(33.450701, 126.570667),  // 원의 중심좌표 입니다
//        radius: 50, // 미터 단위의 원의 반지름입니다
        strokeWeight: 2, // 선의 두께입니다
        strokeColor: '#75B8FA', // 선의 색깔입니다
        strokeOpacity: 0.5, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
        strokeStyle: 'dashed', // 선의 스타일 입니다
        fillColor: '#CFE7FF', // 채우기 색깔입니다
        fillOpacity: 0.7  // 채우기 불투명도 입니다
    };

    function drawClear() {
        showMarkers(null);
        if (selectedItem.area != null)
            selectedItem.area.setMap(null);
        if (selectedItem.center != null)
            selectedItem.center.setMap(null);
        markers = [];
        selectedItem.center = null;
    }

    function drawCircle() {
        var center = {lat: 0, lng: 0};
        var centerLatLng = null;
        var maxDistance = 0;

        // 초기화
        if (selectedItem.area != null)
            selectedItem.area.setMap(null);
        if (selectedItem.center != null)
            selectedItem.center.setMap(null);

        // 중간 지점 찾아내기
        for (var i = 0; i < markers.length; i++) {
//            circlePath.push(markers[i].getPosition());
            center.lat += markers[i].getPosition().getLat();
            center.lng += markers[i].getPosition().getLng();
        }
        center.lat = center.lat / markers.length;
        center.lng = center.lng / markers.length;
        centerLatLng = new daum.maps.LatLng(center.lat, center.lng);
        selectedItem.center = showMarker(centerLatLng, {});
        // 중심점
//        console.log("center : " + center.lat + ", " + center.lng);

        // 중심 주소 찾아내기
        searchAddrFromCoords(centerLatLng, function (status, result) {
            if (status === daum.maps.services.Status.OK) {
                selectedItem.addressName = result[0].fullName;
                // 중심 주소
//                console.log("address Name : " + selectedItem.addressName);
                // 전철역 찾기
                searchPlaces(selectedItem.addressName + " 전철", function (places) {
                    // 전철 초기화
                    selectedItem.transPlaces = places;
                    selectedItem.transMarkers = [];

                    // show Tran
                    for (var i = 0; i < places.length && i < 3; i++) {
                        var latLng = new daum.maps.LatLng(places[i].latitude, places[i].longitude);

                        // 이미지 지정
                        var imageSrc = 'http://i1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png', // 마커 이미지 url, 스프라이트 이미지를 씁니다
                                imageSize = new daum.maps.Size(36, 37),  // 마커 이미지의 크기
                                imgOptions =  {
                                    spriteSize : new daum.maps.Size(36, 691), // 스프라이트 이미지의 크기
                                    spriteOrigin : new daum.maps.Point(0, (i*46)+10), // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
                                    offset: new daum.maps.Point(13, 37) // 마커 좌표에 일치시킬 이미지 내에서의 좌표
                                },
                                markerImage = new daum.maps.MarkerImage(imageSrc, imageSize, imgOptions);
                        var marker = showMarker(latLng, {
                            image: markerImage
                        });

                        // 마커 항목에 mouseover 했을때
                        // 해당 장소에 인포윈도우에 장소명을 표시합니다
                        // mouseout 했을 때는 인포윈도우를 닫습니다
                        (function(marker, title) {
                            daum.maps.event.addListener(marker, 'mouseover', function() {
                                var content = '<div style="padding:5px;z-index:1;">' + title + '</div>';

                                infowindow.setContent(content);
                                infowindow.open(map, marker);
                            });

                            daum.maps.event.addListener(marker, 'mouseout', function() {
                                infowindow.close();
                            });
                        })(marker, places[i].title);
                    }
                    // 가까운 전철역 보여주기
//                    var res = "";
//                    for(var i=0; i<places.length; i++)
//                        res += places[i].title + " ";
//                    console.log("중심에 가까운 전철역 " + res);
                });
            }
        });

        for (var i = 0; i < markers.length; i++) {
            var line = [];

            line.push(markers[i].getPosition());
            line.push(centerLatLng);

            var distance = (new daum.maps.Polygon({
                path: line // 그려질 다각형의 좌표 배열입니다
            })).getLength();
            if (maxDistance < distance)
                maxDistance = distance;
        }
        console.log("distance : " + maxDistance);

        areaConfig.center = centerLatLng;
        areaConfig.radius = maxDistance;

        // 지도에 표시할 선을 생성합니다
        selectedItem.area = new daum.maps.Circle(areaConfig);

        // 지도에 선을 표시합니다
        selectedItem.area.setMap(map);
    }

    // Common
    var collection;
    var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
    var options = { //지도를 생성할 때 필요한 기본 옵션
        center: new daum.maps.LatLng(37.542504779183616, 126.97701084507932), //지도의 중심좌표.
        level: 8
        //지도의 레벨(확대, 축소 정도)
    };
    var map = new daum.maps.Map(container, options); //지도 생성 및 객체 리턴

    // Marker TODO
    function showMarker(latLng, config) {
        var marker = new daum.maps.Marker(config);
        marker.setPosition(latLng);
        marker.setMap(map);
        return marker;
    }

    function showMarkers(map) {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
    }

    // Place TODO
    // 주소-좌표 변환 객체를 생성합니다
    var geocoder = new daum.maps.services.Geocoder();
    // 장소 검색 객체를 생성합니다
    var ps = new daum.maps.services.Places();
    // 검색 결과 목록이나 마커를 클릭했을 때 장소명을 표출할 인포윈도우를 생성합니다
    var infowindow = new daum.maps.InfoWindow({zIndex:1});

    function searchAddrFromCoords(coords, callback) {
        // 좌표로 주소 정보를 요청합니다
        geocoder.coord2addr(coords, callback);
    }

    // 키워드 검색을 요청하는 함수입니다
    function searchPlaces(keyword, callback) {
        if (!keyword.replace(/^\s+|\s+$/g, '')) {
            console.log('잘못된 키워드');
            return false;
        }
        // 장소검색 객체를 통해 키워드로 장소검색을 요청합니다
        // 장소검색이 완료됐을 때 호출되는 콜백함수 입니다
        ps.keywordSearch(keyword, function placesSearchCB(status, data, pagination) {
            if (status === daum.maps.services.Status.OK) {
                callback(data.places);

            } else if (status === daum.maps.services.Status.ZERO_RESULT) {
                alert('검색 결과가 존재하지 않습니다.');
                return;
            } else if (status === daum.maps.services.Status.ERROR) {
                alert('검색 결과 중 오류가 발생했습니다.');
                return;
            }
        });
        return true;
    }
    // bounds_changed 이벤트
    daum.maps.event.addListener(map, 'bounds_changed', function() {
        window.DaumApp.onScrollChangedCallback();
        window.DaumApp.test("test111");
    });

    /*
     var imageSrc = 'http://i1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png', // 마커 이미지 url, 스프라이트 이미지를 씁니다
     imageSize = new daum.maps.Size(36, 37),  // 마커 이미지의 크기
     imgOptions =  {
     spriteSize : new daum.maps.Size(36, 691), // 스프라이트 이미지의 크기
     spriteOrigin : new daum.maps.Point(0, (idx*46)+10), // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
     offset: new daum.maps.Point(13, 37) // 마커 좌표에 일치시킬 이미지 내에서의 좌표
     },
     markerImage = new daum.maps.MarkerImage(imageSrc, imageSize, imgOptions),
     marker = new daum.maps.Marker({
     position: position, // 마커의 위치
     image: markerImage
     });
     */


    // 검색결과 항목을 Element로 반환하는 함수입니다
    function getListItem(index, places) {

        var el = document.createElement('li'),
                itemStr = '<span class="markerbg marker_' + (index + 1) + '"></span>' +
                        '<div class="info">' +
                        '   <h5>' + places.title + '</h5>';

        if (places.newAddress) {
            itemStr += '    <span>' + places.newAddress + '</span>' +
            '   <span class="jibun gray">' + places.address + '</span>';
        } else {
            itemStr += '    <span>' + places.address + '</span>';
        }

        itemStr += '  <span class="tel">' + places.phone + '</span>' +
        '</div>';

        el.innerHTML = itemStr;
        el.className = 'item';

        return el;
    }

    // Transfer TODO
    function test() {
        drawCircle();
        // window.DaumApp.test("test111");
    }

    function receiveCode(json) {
        collection = eval(json);
        alert(collection[code]);
    }

    function sendCode(params) {
        window.DaumApp.sendCode(JSON.stringify(params));
    }

    // Event
    daum.maps.event.addListener(map, 'click', function (mouseEvent) {
        window.DaumApp.ToggleToolbar();
    });

    daum.maps.event.addListener(map, 'rightclick', function (mouseEvent) {
        // 클릭한 위도, 경도 정보를 가져옵니다
        var latlng = mouseEvent.latLng;
        markers.push(showMarker(latlng, {}));
    });

    // Tmp
    function drawFillPolygon() {
        /*
         {
         //        path:, // 그려질 다각형의 좌표 배열입니다
         strokeWeight: 2, // 선의 두께입니다
         strokeColor: '#FFFFFF', // 선의 색깔입니다
         strokeOpacity: 0.8, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
         strokeStyle: 'longdash', // 선의 스타일입니다
         fillColor: '#000000', // 채우기 색깔입니다
         fillOpacity: 0.3 // 채우기 불투명도 입니다
         };
         */
        var polygonPath = [];

        if (selectedItem.area != null)
            selectedItem.area.setMap(null);

        // 바깥기준으로 정렬 해서 보여줘야할 것
        for (var i = 0; i < markers.length; i++) {
            polygonPath.push(markers[i].getPosition());
//            console.log(markers[i].getPosition());
        }
        areaConfig.path = polygonPath;

        // 지도에 표시할 선을 생성합니다
        selectedItem.area = new daum.maps.Polygon(areaConfig);

        // 지도에 선을 표시합니다
        selectedItem.area.setMap(map);
    }
</script>
</body>
</html>